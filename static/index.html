{% load static %}
{% static }
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>VICVAR COMPUTERS</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <img src="{% static 'img/logo_vicvar_computer.png' %}" alt="Logo">
    <link rel="icon" href="{% static 'favicon.ico' %}" type="image/x-icon">
</head>
<body>

<div class="cart-icon-container-floating">
    <button id="cart-button" class="btn-cart">
      <i class="fas fa-shopping-cart"></i> <span id="cart-count" class="cart-count">0</span>
    </button>
</div>
<div id="cart-modal" class="modal">
    <div class="modal-content cart-modal-content">
        <span class="close-button" id="cerrar-cart-modal">&times;</span>

        <h2>Tu Carrito de Compras</h2>
        
        <div id="cart-items-container" class="cart-items-container">
            <p id="empty-cart-message">El carrito está vacío.</p>
        </div>

        <div class="cart-summary">
            <p>Total de Artículos: <span id="cart-total-items">0</span></p>
            <p>Total a Pagar: <span id="cart-total-price">$0.00</span></p>
        </div>

        <div class="cart-actions">
            <button id="checkout-button" class="btn btn-primary">Proceder al Pago</button>
            <button id="clear-cart-button" class="btn btn-secondary">Vaciar Carrito</button>
        </div>
    </div>
</div>
<header class="main-header">
    <div class="header-content">
        <div class="header-branding">
            <div class="logo">
                <img src="{% static 'img/logo_vicvar_computer.png' %}" alt="Logo VICVAR COMPUTER"> {# Modificado #}
            </div>
            <div class="header-tittle">VICVAR COMPUTER</div>
        </div>
        <nav class="main-nav">
            <ul>
                <li><a href="#Inicio">Inicio</a></li>
                <li><a href="#catalogo">Catálogo</a></li>
                <li><a href="#contacto">Contacto</a></li>
            </ul>
        </nav>
    </div>
</header>

<section id="Inicio" class="hero-section">
    <div class="container hero-content">
        <div class="hero-text">
            <h1>Servicios profesionales</h1>
            <h2>Armados de Computadoras <br> Reparación y Ventas de Componentes</h2>
            <p>Somos el número uno en armado de computadoras, venta de componentes y reparación en todo México</p>
            <div class="hero-buttons">
                <a href="#servicios" class="btn btn-primary">SERVICIOS</a>
                <a href="#contacto" class="btn btn-secondary">CONTACTO</a>
            </div>
        </div>
        <div class="hero-image">
            <img src="{% static 'img/imagen_componentes_hero.png' %}" alt="Componentes de PC y Computadora Armada"> {# Modificado #}
        </div>
    </div>
</section>

<section id="computadoras-armadas" class="section-computadoras-armadas">
    <div class="container">
        <h2>COMPUTADORAS ARMADAS</h2>
        <p class="subtitle">Explora nuestras configuraciones pre-ensambladas</p>

        <div class="carousel-navigation">
            <button id="computadoras-prev-btn" class="carousel-button">
                <i class="fas fa-chevron-left"></i>
            </button>
            <div class="computadoras-armadas-grid" id="computadoras-armadas-grid">
                </div>
            <button id="computadoras-next-btn" class="carousel-button">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
        <div class="ver-mas-container">
            <a href="#catalogo" class="btn btn-primary">VER TODAS LAS COMPUTADORAS ARMADAS</a>
        </div>
    </div>
</section>

<section class="mid-banner">
    <div class="container">
        <h3>Armados de computadoras profesionales para <br> Gaming, diseño, oficina y muchos más.</h3>
    </div>
</section>

<section id="servicios" class="section-services">
    <div class="container">
        <h2>Nuestros Servicios</h2>
        <p class="subtitle">Estos son los servicios que manejamos en VICVAR COMPUTER</p>
        <div class="services-grid">
            <div class="service-card">
                <img src="{% static 'img/servicio_componentes.jpg' %}" alt="Venta de Componentes"> {# Modificado #}
                <h3>Venta de Componentes</h3>
                <a href="#catalogo" class="btn btn-tertiary">Catálogo</a>
            </div>
            <div class="service-card">
                <img src="{% static 'img/servicio_armador.png' %}" alt="Armador de Computadoras"> {# Modificado #}
                <h3>Armador de Computadoras</h3>
                <a href="#" class="btn btn-tertiary">Contacto</a>
            </div>
            <div class="service-card">
                <img src="{% static 'img/servicio_reparacion.jpg' %}" alt="Reparación de Computadoras"> {# Modificado #}
                <h3>Reparación de Computadoras</h3>
                <a href="#" class="btn btn-tertiary">Contacto</a>
            </div>
        </div>
    </div>
</section>


<section id="catalogo" class="section-catalogo">
    <div class="container catalogo-layout">
        <aside class="filtros">
            <h3>Buscar producto</h3>
            <input type="text" id="busqueda-producto" placeholder="Buscar producto..." />
            <h3>Filtrar por categoría</h3>
            <div class="filtro-existencia" style="margin-bottom: 10px;">
                <label>
                    <input type="checkbox" id="filtro-existencia">
                    Solo en existencia
                </label>
            </div>
            <div id="filtros-categorias" class="filtros-categorias">
                </div>
        </aside>

        <main class="catalogo">
            <div id="catalogo-grid" class="catalogo-grid">
                </div>

            <div class="pagination-container">
                <button id="prev-page" class="pagination-button" disabled>Anterior</button>
                <div id="page-numbers" class="page-numbers">
                    </div>
                <button id="next-page" class="pagination-button">Siguiente</button>
            </div>
            <span id="total-productos"></span>
        </main>
    </div>
</section>
<section id="contacto" class="cta-location">
    <div class="container">
        <h3>¿Necesitas asesoría o una cotización personalizada?</h3>
        <div class="cta-buttons">
            <a href="mailto:tu_correo@example.com" class="btn btn-primary">Envíanos un Email</a>
            <a href="tel:+525512345678" class="btn btn-secondary">Llámanos</a>
        </div>
    </div>
</section>
<!-- 🔄 Loader mientras se cargan los productos -->
<div id="loader" style="
    display: none;
    text-align: center;
    margin: 40px 0;
    font-size: 18px;
    color: #00467F;
">
    <p><strong>Cargando productos...</strong></p>
</div>

<main id="productos-dinamicos" style="padding: 20px;">
    <h1>Nuestros Productos</h1>
    <div id="catalogo-grid" class="product-list"></div>
    <p id="mensaje-vacio" class="no-products" style="display: none;">No hay productos disponibles en este momento.</p>
</main>


<div id="producto-modal" class="modal">
    <div class="modal-content">
        <span id="close-producto-modal" class="close">&times;</span>
        <img id="modal-imagen" src="" alt="Imagen del producto" class="modal-image">
        <h2 id="modal-nombre"></h2>
        <p id="modal-descripcion-prod"></p>
        <p id="modal-descripcion2-prod"></p>
        <p id="modal-precio"></p>
        <p id="modal-existencia"></p>
        <p id="modal-garantia"></p>
        <div id="modal-proveedores"></div>
    </div>
</div>
<div class="chat-container">
    <div class="chat-header">
        <span>¿Necesitas ayuda?</span>
        <button class="toggle-chat">-</button>
    </div>
    <div class="chat-body" id="chat-body">
        <div class="messages" id="chat-messages">
            </div>
        <form id="chat-form" class="chat-input-form">
            <input type="text" id="chat-message-input" placeholder="Escribe un mensaje..." required>
            <button type="submit">Enviar</button>
        </form>
    </div>
</div>
<footer>
    <div class="footer-content">
        <p>&copy; 2025 VICVAR COMPUTER. Todos los derechos reservados.</p>
    </div>
</footer>


<script>
    document.addEventListener("DOMContentLoaded", function () {
        // --- Funciones de Utilidad ---
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function getCsrfToken() {
            return getCookie('csrftoken');
        }

        // --- Selectores para el chat ---
        const chatMessagesContainer = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const sendChatButton = document.getElementById('send-chat-button');
        const toggleChat = document.querySelector('.toggle-chat');
        const chatBody = document.getElementById('chat-body');

        const userNameInput = document.getElementById('user-name-input');
        const initialQueryInput = document.getElementById('initial-query-input');

        let chatSocket = null;
        let conversationId = null; // Almacenará el ID de la conversación
        let isInitialMessageSent = false; // Indica si ya se envió el primer mensaje con nombre/duda

        // Función para añadir mensajes al contenedor
        function addMessageToChat(message, isUser, timestamp) {
            const messageElement = document.createElement('div');
            messageElement.classList.add(isUser ? 'user-message' : 'bot-message');

            const formattedTimestamp = new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); // Formato HH:MM

            messageElement.innerHTML = `<span class="message-content">${message}</span><span class="timestamp">${formattedTimestamp}</span>`;
            chatMessagesContainer.appendChild(messageElement);
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
        }

        // --- Lógica de conexión y envío del PRIMER mensaje (Nombre y Duda) ---
        sendChatButton.addEventListener('click', async function() {
            if (!isInitialMessageSent) { // Si es el primer mensaje
                const userName = userNameInput.value.trim();
                const initialQuery = initialQueryInput.value.trim();

                if (userName === '' || initialQuery === '') {
                    alert('Por favor, ingresa tu nombre y tu duda inicial.');
                    return;
                }

                // Deshabilitar botón para evitar múltiples envíos
                sendChatButton.disabled = true;

                try {
                    const response = await fetch('/start-chat/', { // URL de la nueva vista start_chat_view
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCsrfToken() // Asegúrate de que esta función CSRF esté definida
                        },
                        body: JSON.stringify({
                            user_display_name: userName,
                            initial_message_text: initialQuery
                        })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        conversationId = data.conversation_id;
                        isInitialMessageSent = true;

                        // Ocultar inputs iniciales y mostrar el input de chat normal
                        userNameInput.style.display = 'none';
                        initialQueryInput.style.display = 'none';
                        chatInput.style.display = 'block';

                        // Limpiar inputs iniciales
                        userNameInput.value = '';
                        initialQueryInput.value = '';

                        // Mostrar el mensaje inicial en el chat (como si lo hubiera enviado el usuario)
                        addMessageToChat(`Nombre: ${userName}\nConsulta: ${initialQuery}`, true, new Date().toISOString());

                        // Establecer la conexión WebSocket ahora que tenemos el conversationId
                        connectWebSocket();

                    } else {
                        alert('Error al iniciar la conversación: ' + (data.error || 'Desconocido'));
                        sendChatButton.disabled = false; // Habilitar de nuevo en caso de error
                    }
                } catch (error) {
                    console.error('Error al iniciar la conversación:', error);
                    alert('Error de red o servidor al iniciar la conversación.');
                    sendChatButton.disabled = false; // Habilitar de nuevo en caso de error
                }
            } else { // Si ya se envió el mensaje inicial, es un mensaje normal de chat
                const message = chatInput.value.trim();
                if (message === '' || !chatSocket || chatSocket.readyState !== WebSocket.OPEN) {
                    return;
                }

                const dataToSend = {
                    'message': message,
                    'sender_is_admin': false, // Siempre false para el usuario final
                };

                chatSocket.send(JSON.stringify(dataToSend));
                addMessageToChat(message, true, new Date().toISOString()); // Añadir al chat localmente
                chatInput.value = ''; // Limpiar el input
            }
        });

        // --- Lógica de conexión WebSocket para mensajes posteriores ---
        function connectWebSocket() {
            if (conversationId) {
                const ws_url = 'ws://' + window.location.host + '/ws/chat/' + conversationId + '/';

                if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
                    chatSocket.close();
                }

                chatSocket = new WebSocket(ws_url);

                chatSocket.onopen = function(e) {
                    console.log('WebSocket connection opened with conversation ID:', conversationId);
                    sendChatButton.disabled = false; // Habilitar el botón de envío
                };

                chatSocket.onmessage = function(e) {
                    const data = JSON.parse(e.data);
                    const message = data.message;
                    const is_admin = data.is_admin;
                    const timestamp = data.timestamp;

                    addMessageToChat(message, !is_admin, timestamp);
                };

                chatSocket.onclose = function(e) {
                    console.warn('WebSocket closed unexpectedly (code:', e.code, 'reason:', e.reason, ').');
                    sendChatButton.disabled = true;
                    // Opcional: Reintento de conexión
                    // setTimeout(connectWebSocket, 3000);
                };

                chatSocket.onerror = function(e) {
                    console.error('WebSocket error:', e);
                };
            } else {
                console.error('No conversationId available to connect WebSocket.');
            }
        }


        // --- Lógica del botón de ocultar/mostrar chat ---
        if (toggleChat && chatBody) {
            toggleChat.addEventListener('click', () => {
                chatBody.classList.toggle('oculto');
                toggleChat.textContent = chatBody.classList.contains('oculto') ? '+' : '-';
            });
        }

        // Si el chat está visible al cargar (por ejemplo, si lo dejaste abierto en una sesión anterior)
        // Puedes agregar una lógica aquí para cargarlo o resetearlo.
        // Por ahora, asumimos que siempre empieza pidiendo nombre y duda.
    });
</script>


<script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
<script src="/static/js/catalogo.js"></script>
</body>
</html>